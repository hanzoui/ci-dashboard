# Secrets: Hanzo KMS (kms.hanzo.ai) â€” auth via Hanzo IAM
name: Expo Update
on:
    push:
        branches:
            - main
            - production
            - staging
        paths:
            - NativeApp/**

jobs:
    eas-update:
        name: EAS Update
        runs-on: ubuntu-latest
        env:
            working-directory: ./NativeApp
        steps:
          - name: Fetch secrets from Hanzo KMS
            id: kms
            uses: hanzoui/.github/actions/kms-secrets@main
            with:
              kms_client_id: ${{ secrets.KMS_CLIENT_ID }}
              kms_client_secret: ${{ secrets.KMS_CLIENT_SECRET }}
              secrets: 'EXPO_TOKEN'
            - name: Check for EXPO_TOKEN
              run: |
                  if [ -z "${{ steps.kms.outputs.EXPO_TOKEN }}" ]; then
                    echo "You must provide an EXPO_TOKEN secret linked to this project's Expo account in this repo's secrets. Learn more: https://docs.expo.dev/eas-update/github-actions"
                    exit 1
                  fi

            - name: Checkout repository
              uses: actions/checkout@v2

            - name: Setup Node
              uses: actions/setup-node@v3
              with:
                  node-version: 16.x
                  cache: npm
                  cache-dependency-path: NativeApp/package-lock.json

            - name: Setup Expo
              uses: expo/expo-github-action@v7
              with:
                  expo-version: latest
                  eas-version: latest
                  token: ${{ steps.kms.outputs.EXPO_TOKEN }}

            - name: Install dependencies
              run: npm install

            - name: Publish update
              run: eas update --auto
